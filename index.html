<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Generador de Códigos QR para Tarjetas de Embarque</title>
		<meta name="description" content="Generador de Códigos QR para Tarjetas de Embarque que puede crear cualquier Código de Embarque para cualquier vuelo.">
		<link rel="stylesheet" href="./css/style_tiizss.css" />
		<link rel="icon" href="./img/favicon.png">
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<script src="./js/bwip-js.min.js"></script>
	</head>
	<body id="body" onload="start()" >
		<header>
			<h1>TiiZss & BullSec Generador de tarjetas de embarque</h1>
			<ul class="menu">
				<li><a class="btn" href="#open-modal" title="Rellena los datos de la tarjeta de embarque"><span class="mdi--cow"></span></a>
				<li><a class="btn" href="#open-modal" title="Rellena los datos de la tarjeta de embarque"><span class="mdi--edit"></span></a>
				<li><label class="btn" for="qrCodeInput" title="Subir código QR de la tarjeta de embarque"><span class="mdi--qrcode-plus"></span></label>
				<li><a class="btn" title="Enlace permanente para guardar en marcadores" id="bookmark" href="#"><span class="mdi--bookmark-plus"></span></a>
				<li><a class="btn" title="Reinicia" id="VolverAEmpezar" href="javascript:location.reload();"><span class="mdi--refresh"></span></a>
			</ul>
		</header>
		<div id="disclaimer-container">
			<div id="disclaimer">
				<h2>Advertencia sobre vulnerabilidad y uso educativo</h2>
				<p>En este sitio web se demuestra una vulnerabilidad de seguridad conocida, pero no divulgada públicamente. La herramienta utilizada para esta demostración ha sido desarrollada exclusivamente con fines educativos y de concienciación sobre los riesgos de seguridad informática.</p>
				<p>El propietario y los colaboradores de este sitio web no se hacen responsables del uso que terceros puedan dar a esta información y herramienta. La explotación de vulnerabilidades de seguridad sin el consentimiento del propietario del sistema afectado es ilegal y puede acarrear consecuencias legales.</p>
				<p><strong>Se prohíbe expresamente el uso de esta herramienta para fines distintos a los educativos y de concienciación.</strong></p>
				<button id="accept-button">Aceptar y continuar</button>
			</div>
		</div>
		<div class="wrapper">
			<main>
				<div>
					<div id="errMsg"></div>
					<div id="qrcode" class="qrcode">
						<img id="theimg2" src="./img/loading.gif" />
						<canvas style="display:none;" id="theimg3"></canvas>
						<canvas style="display:none;" id="barcode"></canvas>				
						<div id="textEdit"></div>
					</div>
				</div>
				<div id="open-modal" class="modal-window">
					<div class="background"></div>
					<div class="foreground">
						<a href="#" title="Close" class="modal-close"><span class="mdi--close-thick"></span></a>
						<div id="inputArea">
							
							<h2>DATOS PASAJERO</h2>
							<div class="row">
								<div class="column">
									<label for="firstName">Nombre del pasajero</label>
									<input id="firstNameEd" name="firstName" type="text" value="" placeholder="Benito" oninput="formatName(true)">
								</div>
								<div class="column">
									<label for="firstName">1er apellido del pasajero</label>
									<input id="lastNameEd" name="lastName" type="text" value="" placeholder="Camela" oninput="formatName(true)">
								</div>
							</div>
							
							<h2>DATOS BILLETE</h2>
							<div class="row">	
								<div class="column">
									<label for="bookingRef">Booking-Ref</label>
									<input id="bookRefEd" name="bookingRef" type="text" value="" placeholder="RC2025" oninput="formatField('bookRef', true)">
								</div>
								<div class="column">
									<label for="date">Fecha del Vuelo</label>
									<input id="dateEd" for="date" type="date" oninput="formatDay(true)">
								</div>
								<div class="column">
									<label for="from">Aeropuerto de origen</label>
									<input id="fromEd" name="for" type="text" value="" placeholder="MAD" oninput="formatField('from', true)">
								</div>
								<div class="column">
									<label for="to">Aeropuerto de destino</label>
									<input id="toEd" for="to" type="text" value="" placeholder="MIA" oninput="formatField('to', true)">
								</div>
								<div class="column">
									<label for="flightOps">Aerolinea</label>
									<input id="fOpEd" name="flightOps" type="text" placeholder="IBE" value="" oninput="formatField('fOp',true)">
								</div>
								<div class="column">
									<label for="number">Número de vuelo</label>
									<input id="fNumEd" name="number" type="text" value="" placeholder="1234" oninput="formatField('fNum', true)">
								</div>
								<div class="column">
									<label for="seat">Asiento</label>
									<input id="seatNumEd" name="seat" type="text" value="" placeholder="30A" oninput="formatSeat(true)">
								</div>
								<div class="column">
									<label for="class">Clase</label>
									<select id="classSel" name="class" onchange="formatClass(true)">
										<option value="Y">Economy</option>
										<option value="C" selected>Business</option>
										<option value="F">Primera</option>
									</select>
								</div>
								<div class="column hide">
									<label for="seqNum">Sequence Number</label>
									<input name="seqNum" id="seqNumEd" value="0000" onchange="formatField('seqNum', true)">
								</div>
								<div class="column hide">
									<label for="dayOfYearEd">Day of year</label>
									<input id="dayOfYearEd" value="0" disabled>
								</div>
								<div class="column hide">
									<label for="eccSelect">Error correction</label>
									<select id="eccSelect" onchange="update()" disabled>
										<option value="0">-1</option>
										<option value="0">0</option>
										<option value="1">1</option>
										<option value="2">2</option>
										<option value="3">3</option>
									</select>
								</div>
							</div>

							<h2>Código QR</h2>
							<div class="row">
								<div class="column">
									<label for="size">Tamaño</label>
									<input id="symSize" name="size" type="number" onchange="update()" value="11">
								</div>
								<div class="column">
									<label for="format">Formato QR</label>
									<select name="format" id="codeTypeSel" onchange="typeUpdate()">
										<option value="0">aztec</option>
										<option value="1">pdf417</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="push"></div>
				<button id="generateButton" onclick="generateBarcode()" style="display: none;">Generar Código</button>
			</main>
		</div>
		
		<div id="reader" width="600px" height="600px" class="hide"></div>
		<input type="file" id="qrCodeInput" accept="image/*" onchange="loadQRCode(this)">

		<script>
			
			var textOut = null
			var textIn = ""
			var fields = {}

			var run, getDayOfYear
			var ctx = null

			var fldDef = {
				'bookRef': { pad: 7, desc:"Booking Ref"},
				'from':    { pad: 3, desc:"From"},
				'to':      { pad: 3, desc:"To"},
				'fOp':     { pad: 3, desc:"Flight Operator"},
				'fNum':    { pad: 5, desc:"Flight Number"},
				'seqNum':  { pad: 4, desc:"Seq Number"}
			}

			function start() {	
				ctx = theimg3.getContext('2d')

				formatSeqNum()
				formatName()
				formatField('bookRef')
				formatField('from')
				formatField('to')
				formatField('fOp')
				formatField('fNum')
				formatField('seqNum')
				formatDay()
				formatClass()
				formatSeat()

				const urlSearchParams = new URLSearchParams(window.location.search);
				const params = Object.fromEntries(urlSearchParams.entries());
				if (Object.keys(params).length > 0) {
					Object.entries(params).forEach(([k, v]) => fields[k] = v)
					document.getElementById("dateEd").value = getDateFromDays(fields.date)
				}

				// Update
				//format()
				update()
			}

			function update_bookmark(queries) {
				let query = Object.entries(queries).map(([k,v]) => `${k}=${v}`)
				document.getElementById('bookmark').href='?' + query.join('&')
			}

			function errclear() {
				errMsg.innerHTML = ''
				errMsg.style.display = 'hidden'
			}
			
			function err(msg) {
				if (errMsg.innerHTML == '') {
					errMsg.innerHTML = msg
					errMsg.style.display = 'block'
				}
			}
			
			function verificarTextEdit() {
				const textEdit = document.getElementById('textEdit');
				const generateButton = document.getElementById('generateButton');

				// Verifica si la cadena contiene la subcadena "M1/" o es vacia
				const texto = textEdit.textContent.trim();
				if (texto.includes("M1/") || texto.length === 0) {
				//if (textEdit.textContent.trim().includes("M1/")) {
					generateButton.style.display = "none"; // Oculta el botón
				} else {
					generateButton.style.display = "block"; // Muestra el botón
				}
			}
			
			// Llama a verificarTextEdit() al cargar la página y después de cada actualización de textEdit
			window.addEventListener('DOMContentLoaded', verificarTextEdit);
			
			function update(fromRaw) {
				let queries = []
				queries['name']				= fields.name
				queries['fOp']				= fields.fOp
				queries['fNum']				= fields.fNum
				queries['from']				= fields.from
				queries['to']				= fields.to
				queries['date']				= fields.date
				queries['seat']				= fields.seat
				queries['bookRef']			= fields.bookRef
				queries['seqNum']			= fields.seqNum
				queries['cls']				= fields.cls

				if (Object.values(queries).includes('')) {
					document.querySelector('.qrcode').style.opacity = '0.3'
				} else {
					document.querySelector('.qrcode').style.opacity = '1'
				}

				update_bookmark(queries)
			
				if (!fromRaw) {
					textEdit.innerHTML = textIn;
				} else {
					textIn = textEdit.value;
				}
				
				verificarTextEdit();
				
				theimg2.onerror = function(e) {
					console.error("Error al cargar SVG:", e);
				};
			}
			
			function format() {
				const elementos = {
					firstNameEd: document.getElementById('firstNameEd'),
					lastNameEd: document.getElementById('lastNameEd'),
					fOpEd: document.getElementById('fOpEd'),
					fNumEd: document.getElementById('fNumEd'),
					fromEd: document.getElementById('fromEd'),
					toEd: document.getElementById('toEd'),
					seatNumEd: document.getElementById('seatNumEd'),
					bookRefEd: document.getElementById('bookRefEd'),
					seqNumEd: document.getElementById('seqNumEd'),
					classSel: document.getElementById('classSel')
				};

				const elementosFaltantes = [];
				const camposVacios = [];

				for (const id in elementos) {
					if (!elementos[id]) {
						elementosFaltantes.push(id);
					} else if (elementos[id].value.trim() === "") {
						camposVacios.push(id);
					}
				}

				if (elementosFaltantes.length === 0 && camposVacios.length === 0) {
					// Todos los elementos existen y no están vacíos

					//  VERIFICAR SI textIn ESTÁ VACÍO ANTES DE CONTINUAR
					if (fields.name.trim() === "" || fields.bookRef.trim() === "" || fields.from.trim() === "" || fields.to.trim() === "" || fields.fOp.trim() === "" || fields.fNum.trim() === "" || fields.date.trim() === "" || fields.cls.trim() === "" || fields.seat.trim() === "" || fields.seqNum.trim() === "") {
						console.log("Al menos un campo está vacío. No se actualiza ni se muestra error.");
						return; // Salir de la función si hay campos vacíos
					}

					document.getElementById('firstNameEd').value = fields.name.trim().split('/')[1].toUpperCase();
					document.getElementById('lastNameEd').value = fields.name.trim().split('/')[0].toUpperCase();
					document.getElementById('fOpEd').value = fields.fOp.toUpperCase();
					document.getElementById('fNumEd').value = fields.fNum.toUpperCase();
					document.getElementById('fromEd').value = fields.from.toUpperCase();
					document.getElementById('toEd').value = fields.to.toUpperCase();
					document.getElementById('seatNumEd').value = fields.seat.toUpperCase();
					document.getElementById('bookRefEd').value = fields.bookRef.toUpperCase();
					document.getElementById('seqNumEd').value = fields.seqNum.toUpperCase();
					if (fields.cls == 'M') fields.cls = 'Y';
					document.getElementById('classSel').value = fields.cls.toUpperCase();

					textIn = "M1"
						+ upPadRight(fields.name, 20)
						+ "E"
						+ upPadRight(fields.bookRef, fldDef['bookRef'].pad)
						+ upPadRight(fields.from, fldDef['from'].pad)
						+ upPadRight(fields.to, fldDef['to'].pad)
						+ upPadRight(fields.fOp, fldDef['fOp'].pad)
						+ upPadRight(fields.fNum, fldDef['fNum'].pad)
						+ padLeft(fields.date, 3)
						+ fields.cls
						+ padLeft(fields.seat, 4)
						+ padLeft(fields.seqNum, 4)
						+ " " + "100"; // 00 - hex length of following data

					update();
					document.getElementById('errMsg').style.display = "none"; // Ocultar errMsg si no hay error

				} else {
					let mensajeError = "";
					if (elementosFaltantes.length > 0) {
						mensajeError += "Error: No se encontraron los siguientes elementos: " + elementosFaltantes.join(", ") + ". ";
					}
					if (camposVacios.length > 0) {
						mensajeError += "Los siguientes campos están vacíos: " + camposVacios.join(", ") + ".";
					}

					console.error(mensajeError);
					err(mensajeError); // Mostrar el mensaje de errorerr(mensajeError);
				}
			}
			
			
			function upPadRight(s, n) {
				s = s.toUpperCase()
				while(s.length < n)
					s = s + ' ';
				return s.substr(0,n)
			}

			function padLeft(s, n) {
				s = s.toUpperCase()
				while(s.length < n)
					s = '0' + s;
				return s.substr(0,n)
			}

			function formatField(name, doRun) {
				errclear('')
				var def = fldDef[name]
				var v = document.getElementById(name + "Ed").value
				if (v.length > def.pad)
					err('"' + def.desc + '" longer than ' + def.pad + " chars")
					fields[name] = v
					if (doRun) format()
			}

			function formatName(doRun) {
				errclear()
				if (lastNameEd.value.length > 18) // need space for slash and last name
					err("first name longer than 18 charcters")
					var v = lastNameEd.value + "/" + firstNameEd.value
					if (v.length > 20)
						err("first+last name longer than 20 characters")
						fields.name = v
						if (doRun) format()
			}

			function formatDay(doRun) {
				var dl = dateEd.value.split('-')
				var mday = parseInt(dl[2])
				var mon = parseInt(dl[1]) - 1  // the range of the input is [1-12]
				var yr = parseInt(dl[0])
				dayOfYearEd.value = dayOfYear(yr, mon, mday)
				fields.date = dayOfYearEd.value
				if (doRun) format()
			}

			function dayOfYear(yr, mon, mday) {
				var now = new Date(yr, mon, mday, 1, 0, 0)
				var start = new Date(yr, 0, 1, 0, 0);
				var diff = now - start;
				var oneDay = 1000 * 60 * 60 * 24;
				var day = Math.floor(diff / oneDay) + 1; // start at 1
				return day
			}

			function getDateFromDays(days) {
				var actualYear = new Date().getFullYear()
				console.log(new Date(actualYear, 0, days))
				console.log(new Date(actualYear, 0, days).toLocaleString('sv').substring(0, 10))
				return new Date(actualYear, 0, days).toLocaleString('sv').substring(0, 10)
			}

			function formatClass(doRun) {
				fields.cls = classSel.value
				if (doRun) format()
			}
			
			function formatSeat(doRun) {
				errclear()
				var n = seatNumEd.value
				if (n.length > 4)
					err("Seat longer than 4 chars")
					fields.seat = n
					if (doRun) format()
			}
			
			function formatSeqNum(doRun) {
				errclear()
				var n = "0" + getRandomArbitrary(300,500)
				if (n.length > 4)
					err("Seq number longer than 4 chars")    
					if (seqNumEd.value == '0000') {
						document.getElementById('seqNumEd').value = n
					} else {
						fields.seqNum = seqNumEd.value
					}
					if (doRun) format()
			}    

			function typeUpdate() {
				if (codeTypeSel.value == "0")
					symSize.value = "11"  // size of the aztec
				else
					symSize.value = "6"  // columns in the barcode
				update()
			}
			
			function getRandomArbitrary(min, max) {
				return Math.round(Math.random() * (max - min) + min);
			}

			function loadQRCode(doRun) {
				errclear()
				if (doRun.files.length == 0) return;
				
				// Scan QR Code
				html5QrCode.scanFile(doRun.files[0], false)
				.then(qr_code_val => {
					fields.name 	= qr_code_val.substring(2, 22)
					fields.bookRef 	= qr_code_val.substring(23, 29).trim()
					fields.from 	= qr_code_val.substring(30, 33).trim()
					fields.to 		= qr_code_val.substring(33, 36).trim()
					fields.fOp 		= qr_code_val.substring(36, 39).trim()
					fields.fNum 	= qr_code_val.substring(39, 44).trim()
					fields.seat 	= qr_code_val.substring(49, 52).trim()
					fields.cls 		= qr_code_val.substring(47, 48).trim()
					fields.date 	= qr_code_val.substring(44, 47).trim()
					fields.seqNum 	= qr_code_val.substring(52, 56).trim()
					document.getElementById("dateEd").value = getDateFromDays(fields.date)
					if (doRun) format()
				})
				.catch(msg => {
					err('Error scanning file. Crop only to QR-Code part.')
					console.log(`Error scanning file. Reason: ${msg}`)
				});
			}
			
			function generateBarcode() {
				
				const formatValue = document.getElementById('codeTypeSel').value;
				let format; // Variable para almacenar el formato ("pdf417" o "azteccode")

				if (formatValue === '1') { // Compara con cadenas porque los valores de input son cadenas
					format = 'pdf417';
				} else if (formatValue === '0') {
					format = 'azteccode';
				} else {
					// Manejo de error: Valor inválido. Puedes mostrar un mensaje de error o asignar un valor por defecto.
					console.error("Valor de formato inválido: " + formatValue);
					format = 'pdf417'; // Valor por defecto (puedes elegir el que prefieras)
				}
				
				const moduleSize = parseInt(document.getElementById('symSize').value);
				const canvas = document.getElementById('barcode');
				const errorDiv = document.getElementById('errMsg');
				
				errorDiv.innerHTML = '';
				
				const barcodeData = document.getElementById('textEdit').textContent;
				
				console.log("format:", format);
				console.log("barcodeData:", barcodeData);
				console.log("moduleSize:", moduleSize);
							
				let options = {
					bcid: format,
					text: barcodeData,
					scale: moduleSize,
					includetext: false,
				};

				if (format === 'pdf417') {
					options.columns = moduleSize;
				} else if (format === 'azteccode') {
					options.layers = moduleSize;
				}

				try {
					bwipjs.toCanvas(canvas, options);
					document.getElementById('theimg2').style.display = 'none';
					document.getElementById('barcode').style.display = 'block';
				} catch (error) {
					errorDiv.innerHTML = 'Error al generar el código. Por favor, verifica los datos ingresados.';
					console.error(error);
				}
			}
			
			const disclaimerContainer = document.getElementById('disclaimer-container');
			const acceptButton = document.getElementById('accept-button');
			const wrapper = document.querySelector('.wrapper');
			const header = document.querySelector('header');

			window.addEventListener('DOMContentLoaded', () => {
				disclaimerContainer.style.display = 'flex';
				wrapper.style.display = 'none';
				header.style.display = 'block';

				acceptButton.addEventListener('click', () => {
					disclaimerContainer.style.display = 'none';
					wrapper.style.display = 'block';
				});
			});
		</script>
	</body>
	<footer>
			<div id="copyright">
				Esta herramienta está destinada únicamente a fines educativos. Utilícela bajo su propio riesgo | 
				This tool is intended for educational purposes only, use at your own personal risk. Use at own risk | 
				<a target="_blank" href="https://github.com/TiiZss/QRPassGen" title="Source code on GitHub">GitHub</a>
			</div>
	</footer>	
</html>